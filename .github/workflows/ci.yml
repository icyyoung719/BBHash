name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-test-linux:
    name: Build and Test (Ubuntu)
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    strategy:
      matrix:
        compiler: [gcc, clang]
        build_type: [Release, Debug]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
        else
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV
        fi
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
    
    - name: Build
      run: |
        cd build
        cmake --build . -j$(nproc)
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
    
    - name: Run examples
      run: |
        cd build
        ./main

  build-and-test-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    
    permissions:
      contents: read
    
    strategy:
      matrix:
        build_type: [Release, Debug]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
    
    - name: Build
      run: |
        cd build
        cmake --build . --config ${{ matrix.build_type }}
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose -C ${{ matrix.build_type }}
    
    - name: Run examples
      run: |
        cd build
        if ("${{ matrix.build_type }}" -eq "Release") {
          .\Release\main.exe
        } else {
          .\Debug\main.exe
        }

  build-and-test-macos:
    name: Build and Test (macOS)
    runs-on: macos-latest
    
    permissions:
      contents: read
    
    strategy:
      matrix:
        build_type: [Release, Debug]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
    
    - name: Build
      run: |
        cd build
        cmake --build . -j$(sysctl -n hw.ncpu)
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
    
    - name: Run examples
      run: |
        cd build
        ./main

  coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Configure CMake (coverage)
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_C_FLAGS="--coverage -O0 -g -fprofile-update=atomic" \
            -DCMAKE_CXX_FLAGS="--coverage -O0 -g -fprofile-update=atomic" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build
        run: cd build && cmake --build . -j$(nproc)

      - name: Run tests
        run: cd build && ctest --output-on-failure

      - name: Capture coverage
        run: |
          cd build
          lcov --rc geninfo_unexecuted_blocks=1 \
            --capture \
            --directory . \
            --output-file coverage.info \
            --include "$(pwd)/include/*"
          lcov --remove coverage.info '/usr/*' '*/catch2/*' '*/tests/*' --output-file coverage.info

      - name: Generate HTML report
        run: genhtml build/coverage.info --output-directory build/coverage_html

      - uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/coverage_html

